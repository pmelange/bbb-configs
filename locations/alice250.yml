---
location: alice250
location_nice:
latitude:
longitude:

contact_nickname: "Perry"
contacts:
  - "isprotejesvalkata [attt] gmail com"

# This only provides an tunneled uplink which is used by the house's
# mwan3 router.  It also repeats various wifi networks.  Still, it's
# considered a core router.  Huh
hosts:
  - hostname: alice250
    role: corerouter
    model: "tplink_tl-wdr4900-v1"
    wireless_profile: alice250
    host__rclocal__to_merge:
      - |
        # set up the ports correctly
        # vlan 500
        uci set network.vlan_500.ports="lan1:t"
        # vlan 501
        uci set network.vlan_501.ports="wan:u lan1:t lan2:t"
        # vlan 211
        uci set network.vlan_211.ports="lan1:t lan2:t"
        # vlan 10
        uci set network.vlan_10.ports="lan1:t lan2:t lan4:u"
        # vlan 5
        uci set network.vlan_5.ports="lan1:t lan2:t lan3:u"
        # vlan 11
        uci set network.vlan_11.ports="lan1:t lan2:t"
        # set the ip address on hauslan because the lint checker doesn't like
        # it in the config.  Huh
        uci -q get network.hauslan.ipaddr > /dev/null
        if [ "1" -eq $? ]; then
          uci set network.hauslan.proto="static"
          uci set network.hauslan.ipaddr="192.168.5.2/24"
        fi
        uci commit network
        # remove the dhcp option from the client network. Again, because
        # this network is special
        uci delete dhcp.dhcp_dhcp.dhcp_option
        # set up DHCP for the non-autoconfigured interfaces properly
        uci -q get dhcp.freifunk.interface > /dev/null
        if [ "1" -eq $? ]; then
          uci set dhcp.freifunk=dhcp
          uci set dhcp.freifunk.interface=freifunk
          uci set dhcp.freifunk.ignore=1
          uci set dhcp.hauslan=dhcp
          uci set dhcp.hauslan.interface=hauslan
          uci set dhcp.hauslan.ignore=1
          uci set dhcp.transtor=dhcp
          uci set dhcp.transtor.interface=transtor
          uci set dhcp.transtor.ignore=1
          uci commit dhcp
          /etc/init.d/dnsmasq restart
        fi
        # reconfigure firewall because the autoconfig is totally wrong
        uci -q get firewall.zone_hauslan.name > /dev/null
        if [ "1" -eq $? ]; then
          uci add_list firewall.zone_freifunk.network=freifunk
          uci set firewall.zone_hauslan=zone
          uci set firewall.zone_hauslan.name=hauslan
          uci set firewall.zone_hauslan.forward=ACCEPT
          uci add_list firewall.zone_hauslan.network=hauslan
          uci set firewall.zone_transtor=zone
          uci set firewall.zone_transtor.name=transtor
          uci set firewall.zone_transtor.forward=ACCEPT
          uci add_list firewall.zone_transtor.network=transtor
          uci commit firewall
        fi
        reload_config

# unused ipv6 blah blah
ipv6_prefix: 2001:bf7:750:b600::/56

# got following prefixes:
# Router:
# --DHCP:  10.230.59.0/30
# --MESH:  10.31.214.150/32 - wireguard mesh
#          10.31.214.151/32 - wireguard mesh

# Disable noping
dhcp_no_ping: false

networks:
  # MESH - PTMP / PTP Links
  - vid: 501
    role: uplink

  - vid: 500
    role: dhcp
    name: dhcp
    prefix: 10.230.59.0/30
    inbound_filtering: false
    enforce_client_isolation: false
    no_corerouter_dns_record: true
    assignments:
      alice250: 1

  - vid: 211
    role: ext
    name: meshlan
    inbound_filtering: false
    enforce_client_isolation: false
    no_corerouter_dns_record: true

  # freifunk client network
  - vid: 10
    role: ext
    name: freifunk
    inbound_filtering: false
    enforce_client_isolation: false
    no_corerouter_dns_record: true

  # hauslan
  - vid: 5
    role: ext
    name: hauslan
    inbound_filtering: false
    enforce_client_isolation: false
    no_corerouter_dns_record: true
    untagged: true

  # transtor
  - vid: 11
    role: ext
    name: transtor
    inbound_filtering: false
    enforce_client_isolation: false
    no_corerouter_dns_record: true

  - role: tunnel
    ifname: ts_wg0
    mtu: 1280
    prefix: 10.31.214.150/32
    wireguard_port: 51820

  - role: tunnel
    ifname: ts_wg1
    mtu: 1280
    prefix: 10.31.214.151/32
    wireguard_port: 51821

# Wireless profile
location__wireless_profiles__to_merge:
  - name: alice250
    ifaces:
      - mode: ap
        ssid: berlin.freifunk.net
        encryption: none
        network: freifunk
        radio: [11a_standard, 11g_standard]
        ifname_hint: ff

      - mode: ap
        ssid: racoon
        encryption: psk-mixed
        key: "file:/root/racoon_pass"
        network: hauslan
        radio: [11a_standard, 11g_standard]
        ifname_hint: haus

      - mode: ap
        ssid: "Transparent Tor"
        encryption: none
        network: transtor
        radio: [11a_standard, 11g_standard]
        ifname_hint: ttor

